import*as t from'https://testingcf.jsdelivr.net/npm/mathjs/+esm';import{default as e}from'https://testingcf.jsdelivr.net/npm/json5/+esm';import{default as a}from'https://testingcf.jsdelivr.net/npm/toml/+esm';import{compare as s}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';function n(t,e){}function i(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]}function r(t){return'array'===t.type}function o(t){return'object'===t.type}const c={SINGLE_VARIABLE_UPDATED:'mag_variable_updated',VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',VARIABLE_UPDATE_STARTED:'mag_variable_update_started'},l='mag_invoke_mvu',d='mag_update_variable';const f=t,u='$__META_EXTENSIBLE__$';function p(t,e,a=!1){if(Array.isArray(t)){let s,n,i=!1,o=a;e&&(r(e)?(i=!0===e.extensible,o=!0===e.recursiveExtensible||a,s=e.elementType,n=e.template):console.error(`Type mismatch: expected array schema but got ${e.type} at path`));const c=t.findIndex(t=>_.isObject(t)&&!_.isDate(t)&&'$arrayMeta'in t&&'$meta'in t&&!0===t.$arrayMeta);if(-1!==c){const e=t[c];void 0!==e.$meta.extensible&&(i=e.$meta.extensible),void 0!==e.$meta.template&&(n=e.$meta.template),t.splice(c,1),console.log('Array metadata element found and processed.')}const l=t.indexOf(u);l>-1&&(i=!0,t.splice(l,1),console.log('Extensible marker found and removed from an array.'));const d={type:'array',extensible:i||a,recursiveExtensible:o,elementType:t.length>0?p(t[0],s,o):{type:'any'}};return void 0!==n&&(d.template=n),d}if(_.isObject(t)&&!_.isDate(t)){const s=t;let n,i=!1,r=a;e&&(o(e)?(i=!0===e.extensible,r=!0===e.recursiveExtensible||a,n=e.properties):console.error(`Type mismatch: expected object schema but got ${e.type} at path`));const c={type:'object',properties:{},extensible:i||!0===s.$meta?.extensible||!0===s.$meta?.recursiveExtensible||a,recursiveExtensible:r||!0===s.$meta?.recursiveExtensible};void 0!==s.$meta?.template?c.template=s.$meta.template:e&&o(e)&&e.template&&(c.template=e.template);const l=s.$meta;s.$meta&&delete s.$meta;for(const e in t){const t=n?.[e],a=!1!==c.extensible&&c.recursiveExtensible,i=p(s[e],t,a);let r=!c.extensible;Array.isArray(l?.required)&&l.required.includes(e)&&(r=!0),!1===t?.required?r=!1:!0===t?.required&&(r=!0),c.properties[e]={...i,required:r}}return c}const s=typeof t;return'string'===s||'number'===s||'boolean'===s?{type:s}:{type:'any'}}function m(t,e){if(!e||!t)return t||null;const a=_.toPath(e);let s=t;for(const t of a){if(!s)return null;if(/^\d+$/.test(t)){if(!r(s))return null;s=s.elementType}else{if(!o(s)||!s.properties[t])return null;s=s.properties[t]}}return s}function g(t){console.log('Reconciling schema with current data state...');const e=p(_.cloneDeep(t.stat_data),t.schema);if(!o(e))return void console.error('Generated schema is not an object schema, which is unexpected for stat_data root');const a=e;void 0!==t.schema?.strictTemplate&&(a.strictTemplate=t.schema.strictTemplate),void 0!==t.schema?.strictSet&&(a.strictSet=t.schema.strictSet),void 0!==t.schema?.concatTemplateArray&&(a.concatTemplateArray=t.schema.concatTemplateArray),_.has(t.stat_data,'$meta.strictTemplate')&&(a.strictTemplate=t.stat_data.$meta?.strictTemplate),_.has(t.stat_data,'$meta.strictSet')&&(a.strictSet=t.stat_data.$meta?.strictSet),_.has(t.stat_data,'$meta.concatTemplateArray')&&(a.concatTemplateArray=t.stat_data.$meta?.concatTemplateArray),t.schema=a,console.log('Schema reconciliation complete.')}function y(t){if(Array.isArray(t)){let e=t.length;for(;e--;)t[e]===u||_.isObject(t[e])&&!_.isDate(t[e])&&'$arrayMeta'in t[e]&&'$meta'in t[e]&&!0===t[e].$arrayMeta?t.splice(e,1):y(t[e])}else if(e=t,_.isObject(e)&&!_.isDate(e)){delete t.$meta;for(const e in t)y(t[e])}var e}const h={是否显示变量更新错误:'是',构建信息:'未知'},b={type:'script',script_id:'function'==typeof getScriptId?getScriptId():'default-script-id'};function v(t){const e=['是否显示变量更新错误'];for(const a of e)if(a in t){const e=t[a];('string'!=typeof e||'是'!==e)&&(t[a]='否')}}function A(t){try{t.构建信息='2025-08-29T14:46:56.564Z (3113279)'}catch(t){}}async function E(){const t=getVariables(b)||{};if(!function(t){return!(!t||'object'!=typeof t)&&'是否显示变量更新错误'in t&&'string'==typeof t.是否显示变量更新错误}(t)){const e=_.merge({},h,t);return v(e),A(e),await replaceVariables(e,b),e}const e=_.merge({},h,t);return v(e),A(e),_.isEqual(t,e)||await replaceVariables(e,b),e}function S(t){return _.isString(t)?t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):t}function w(t,e,a=!1,s=!0){if(!e)return t;const n=_.isObject(t)&&!Array.isArray(t)&&!_.isDate(t),i=Array.isArray(t),r=Array.isArray(e);return n&&!r?_.merge({},e,t):i&&r?s?_.concat(t,e):_.merge([],e,t):(n||i)&&r!==i||!n&&!i&&_.isObject(e)&&!Array.isArray(e)?(console.error(`Template type mismatch: template is ${r?'array':'object'}, but value is ${i?'array':'object'}. Skipping template merge.`),t):n||i||!r||a?t:s?_.concat([t],e):_.merge([],e,[t])}function O(t){if('string'!=typeof t)return t;const e=t.trim();if('true'===e)return!0;if('false'===e)return!1;if('null'===e)return null;if('undefined'!==e){try{return JSON.parse(e)}catch(t){if(e.startsWith('{')&&e.endsWith('}')||e.startsWith('[')&&e.endsWith(']'))try{const t=new Function(`return ${e};`)();if(_.isObject(t)||Array.isArray(t))return t}catch(t){}}try{const t={Math,math:f},a=f.evaluate(e,t);if(f.isComplex(a)||f.isMatrix(a))return a.toString();if(void 0===a&&!/^[a-zA-Z_]+$/.test(e))return e;if(void 0!==a)return parseFloat(a.toPrecision(12))}catch(t){}try{return YAML.parse(e)}catch(t){}return S(t)}}function D(t,e){let a=1,s=!1,n='';for(let i=e;i<t.length;i++){const e=t[i],r=i>0?t[i-1]:'';if('"'!==e&&'\''!==e&&'`'!==e||'\\'===r||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if('('===e)a++;else if(')'===e&&(a--,0===a))return i}return-1}function I(t){const e=[];let a='',s=!1,n='',i=0,r=0,o=0;for(let c=0;c<t.length;c++){const l=t[c];'"'!==l&&'\''!==l&&'`'!==l||0!==c&&'\\'===t[c-1]||(s?l===n&&(s=!1):(s=!0,n=l)),s||('('===l&&o++,')'===l&&o--,'['===l&&i++,']'===l&&i--,'{'===l&&r++,'}'===l&&r--),','!==l||s||0!==o||0!==i||0!==r?a+=l:(e.push(a.trim()),a='')}return a.trim()&&e.push(a.trim()),e}async function T(t){return structuredClone(_(SillyTavern.chat).slice(0,t+1).map(t=>_.get(t,['variables',t.swipe_id??0])).findLast(t=>_.has(t,'stat_data')))??getVariables()}function N(t){const e=[];let a='',s=!1,n='';for(let i=0;i<t.length;i++){const r=t[i];'"'!==r&&'\''!==r||0!==i&&'\\'===t[i-1]?'.'!==r||s?a+=r:(e.push(a),a=''):s?r===n?s=!1:a+=r:(s=!0,n=r)}return a&&e.push(a),e.join('.')}async function M(t,e,a,s='',n=!1){const i=t.$internal?.display_data,r=t.$internal?.delta_data;if(_.has(t,e)){const o=_.get(t,e);if(Array.isArray(o)&&2===o.length){const l=_.cloneDeep(o[0]);o[0]=a,_.set(t,e,o);const d=s?`(${s})`:'',f=`${S(JSON.stringify(l))}->${S(JSON.stringify(a))} ${d}`;return i&&_.set(i,e,f),r&&_.set(r,e,f),console.info(`Set '${e}' to '${S(JSON.stringify(a))}' ${d}`),n&&await eventEmit(c.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}{const l=_.cloneDeep(o);_.set(t,e,a);const d=s?`(${s})`:'',f=S(JSON.stringify(a)),u=`${S(JSON.stringify(l))}->${f} ${d}`;return i&&_.set(i,e,u),r&&_.set(r,e,u),console.info(`Set '${e}' to '${f}' ${d}`),n&&await eventEmit(c.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}}return!1}async function j(t,e){const a=!1,s=_.cloneDeep(e),l={stat_data:{}},d=function(t){const e=[];let a=0;for(;a<t.length;){const s=t.substring(a).match(/_\.(set|insert|assign|remove|unset|delete|add)\(/);if(!s||void 0===s.index)break;const n=s[1],i=a+s.index,r=i+s[0].length,o=D(t,r);if(-1===o){a=r;continue}let c=o+1;if(c>=t.length||';'!==t[c]){a=o+1;continue}c++;let l='';const d=t.substring(c).match(/^\s*\/\/(.*)/);d&&(l=d[1].trim(),c+=d[0].length);const f=t.substring(i,c),u=I(t.substring(r,o));let p=!1;('set'===n&&u.length>=2||'assign'===n&&u.length>=2||'insert'===n&&u.length>=2||'remove'===n&&u.length>=1||'unset'===n&&u.length>=1||'delete'===n&&u.length>=1||'add'===n&&2===u.length)&&(p=!0),p&&e.push({command:n,fullMatch:f,args:u,reason:l}),a=c}return e}(substitudeMacros(t)),f=await E();e.stat_data.$internal={display_data:s.stat_data,delta_data:l.stat_data||{}},await eventEmit(c.VARIABLE_UPDATE_STARTED,e,a);let u,p,y=!1;const h=function(t){console.warn(t),u={error_last:t,error_command:p}},b=e.schema,v=b?.strictTemplate??!1,A=b?.concatTemplateArray??!0,T=b?.strictSet??!1;for(const t of d){const a=N(S(t.args[0])),d=t.reason?`(${t.reason})`:'';let f='';switch(p=t,t.command){case'set':{if(!_.has(e.stat_data,a)){h(`Path '${a}' does not exist in stat_data, skipping set command ${d}`);continue}let s=_.get(e.stat_data,a);let r=O(t.args.length>=3?t.args[2]:t.args[1]);r instanceof Date&&(r=r.toISOString());let o=!1;if(T||!Array.isArray(s)||2!==s.length||'string'!=typeof s[1]||Array.isArray(s[0]))'number'==typeof s&&null!==r?_.set(e.stat_data,a,Number(r)):_.set(e.stat_data,a,r);else{const t=_.cloneDeep(s[0]);s[0]='number'==typeof s[0]&&null!==r?Number(r):r,s=t,o=!0}let l=_.get(e.stat_data,a);n(),o&&(l=l[0]);f=!T&&i(s)&&Array.isArray(l)?`${S(JSON.stringify(s[0]))}->${S(JSON.stringify(l[0]))} ${d}`:`${S(JSON.stringify(s))}->${S(JSON.stringify(l))} ${d}`,y=!0,console.info(`Set '${a}' to '${JSON.stringify(l)}' ${d}`),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,l);break}case'insert':case'assign':{const s=a,n=''===s?e.stat_data:_.get(e.stat_data,s),i=m(b,s);if(null!==n&&!Array.isArray(n)&&!_.isObject(n)){h(`Cannot assign into path '${s}' because it holds a primitive value (${typeof n}). Operation skipped. ${d}`);continue}if(i){if('object'===i.type&&!1===i.extensible){if(2===t.args.length){h(`SCHEMA VIOLATION: Cannot merge data into non-extensible object at path '${s}'. ${d}`);continue}if(t.args.length>=3){const e=String(O(t.args[1]));if(!_.has(i.properties,e)){h(`SCHEMA VIOLATION: Cannot assign new key '${e}' into non-extensible object at path '${s}'. ${d}`);continue}}}else if('array'===i.type&&(!1===i.extensible||void 0===i.extensible)){h(`SCHEMA VIOLATION: Cannot assign elements into non-extensible array at path '${s}'. ${d}`);continue}}else if(''!==s&&!_.get(e.stat_data,_.toPath(s).slice(0,-1).join('.'))){h(`Cannot assign into non-existent path '${s}' without an extensible parent. ${d}`);continue}const l=_.cloneDeep(_.get(e.stat_data,a));let u=!1;if(2===t.args.length){let n=O(t.args[1]);n instanceof Date?n=n.toISOString():Array.isArray(n)&&(n=n.map(t=>t instanceof Date?t.toISOString():t));let o=''===s?e.stat_data:_.get(e.stat_data,a);if(Array.isArray(o)||_.isObject(o)||(o=Array.isArray(n)?[]:{},_.set(e.stat_data,a,o)),Array.isArray(o)){n=w(n,i&&r(i)?i.template:void 0,v,A),o.push(n),f=`ASSIGNED ${JSON.stringify(n)} into array '${a}' ${d}`,u=!0}else if(_.isObject(o)){if(!_.isObject(n)||Array.isArray(n)){h(`Cannot merge ${Array.isArray(n)?'array':'non-object'} into object at '${a}'`);continue}_.merge(o,n),f=`MERGED object ${JSON.stringify(n)} into object '${a}' ${d}`,u=!0}}else if(t.args.length>=3){let n=O(t.args[2]);const c=O(t.args[1]);n instanceof Date?n=n.toISOString():Array.isArray(n)&&(n=n.map(t=>t instanceof Date?t.toISOString():t));let l=''===s?e.stat_data:_.get(e.stat_data,a);const p=i&&(r(i)||o(i))?i.template:void 0;Array.isArray(l)&&'number'==typeof c?(n=w(n,p,v,A),l.splice(c,0,n),f=`ASSIGNED ${JSON.stringify(n)} into '${a}' at index ${c} ${d}`,u=!0):_.isObject(l)?(n=w(n,p,v,A),l[String(c)]=n,f=`ASSIGNED key '${c}' with value ${JSON.stringify(n)} into object '${a}' ${d}`,u=!0):(l={},_.set(e.stat_data,a,l),n=w(n,p,v,A),l[String(c)]=n,f=`CREATED object at '${a}' and ASSIGNED key '${c}' ${d}`,u=!0)}if(!u){h(`Invalid arguments for _.assign on path '${a}'`);continue}{const t=_.get(e.stat_data,a);y=!0,console.info(f),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,t)}break}case'unset':case'delete':case'remove':{if(!_.has(e.stat_data,a)){h(`undefined Path: ${a} in _.remove command`);continue}let s,n=a;if(t.args.length>1)s=O(t.args[1]),'string'==typeof s&&(s=S(s));else{const t=_.toPath(a),e=t.pop();e&&(s=/^\d+$/.test(e)?Number(e):e,n=t.join('.'))}if(void 0===s){h(`Could not determine target for deletion for command on path '${a}' ${d}`);continue}if(''!==n&&!_.has(e.stat_data,n)){h(`Cannot remove from non-existent path '${n}'. ${d}`);continue}const i=m(b,n);if(i)if('array'===i.type){if(!0!==i.extensible){h(`SCHEMA VIOLATION: Cannot remove element from non-extensible array at path '${n}'. ${d}`);continue}}else if('object'===i.type){const t=String(s);if(_.has(i.properties,t)&&!0===i.properties[t].required){h(`SCHEMA VIOLATION: Cannot remove required key '${t}' from path '${n}'. ${d}`);continue}}const r=t.args.length>1?O(t.args[1]):void 0;let o=!1;if(void 0===r){const t=_.get(e.stat_data,a);_.unset(e.stat_data,a),f=`REMOVED path '${a}' ${d}`,o=!0,await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,t,void 0)}else{const t=_.get(e.stat_data,a);if(!Array.isArray(t)&&!_.isObject(t)){h(`Cannot remove from path '${a}' because it is not an array or object. Skipping command. ${d}`);continue}if(Array.isArray(t)){const s=_.cloneDeep(t);let n=-1;n='number'==typeof r?r:t.findIndex(t=>_.isEqual(t,r)),n>=0&&n<t.length&&(t.splice(n,1),o=!0,f=`REMOVED item from '${a}' ${d}`,await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,t))}else if(_.isObject(t))if('number'==typeof r){const e=Object.keys(t),s=r;if(s>=0&&s<e.length){const n=e[s];_.unset(t,n),o=!0,f=`REMOVED ${s+1}th entry ('${n}') from object '${a}' ${d}`}}else{const e=String(r);_.has(t,e)&&(delete t[e],o=!0,f=`REMOVED key '${e}' from object '${a}' ${d}`)}}if(!o){h(`Failed to execute remove on '${a}'`);continue}y=!0,console.info(f);break}case'add':{if(!_.has(e.stat_data,a)){h(`Path '${a}' does not exist in stat_data, skipping add command ${d}`);continue}const s=_.cloneDeep(_.get(e.stat_data,a)),r=_.get(e.stat_data,a);let o=r;const l=i(r)&&'object'!=typeof r[0];l&&(n(),o=r[0]);let u=null;if(o instanceof Date)u=o;else if('string'==typeof o){const t=new Date(o);!isNaN(t.getTime())&&isNaN(Number(o))&&(u=t)}if(2!==t.args.length){h(`Invalid number of arguments for _.add on path '${a}' ${d}`);continue}{const i=O(t.args[1]);if(u){if('number'!=typeof i){h(`Delta '${t.args[1]}' for Date operation is not a number, skipping add command ${d}`);continue}const o=new Date(u.getTime()+i),p=o.toISOString();l?(n(),r[0]=p,_.set(e.stat_data,a,r)):_.set(e.stat_data,a,p);const m=_.get(e.stat_data,a);f=l?`${JSON.stringify(s[0])}->${JSON.stringify(m[0])} ${d}`:`${JSON.stringify(s)}->${JSON.stringify(m)} ${d}`,y=!0,console.info(`ADDED date '${a}' from '${u.toISOString()}' to '${o.toISOString()}' by delta '${i}'ms ${d}`),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,m)}else{if('number'!=typeof o){h(`Path '${a}' value is not a date or number; skipping add command ${d}`);continue}{if('number'!=typeof i){h(`Delta '${t.args[1]}' is not a number, skipping add command ${d}`);continue}let n=o+i;n=parseFloat(n.toPrecision(12)),l?(r[0]=n,_.set(e.stat_data,a,r)):_.set(e.stat_data,a,n);const u=_.get(e.stat_data,a);f=l?`${JSON.stringify(s[0])}->${JSON.stringify(u[0])} ${d}`:`${JSON.stringify(s)}->${JSON.stringify(u)} ${d}`,y=!0,console.info(`ADDED number '${a}' from '${o}' to '${n}' by delta '${i}' ${d}`),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,u)}}}break}}f&&(_.set(s.stat_data,a,f),_.set(l.stat_data,a,f))}if(e.display_data=s.stat_data,e.delta_data=l.stat_data,await eventEmit(c.VARIABLE_UPDATE_ENDED,e,a),delete e.stat_data.$internal,y&&g(e),u&&'是'===f.是否显示变量更新错误){const t=u.error_command.fullMatch;'undefined'!=typeof toastr&&toastr.warning(`最近错误: ${u.error_last}`,`发生变量更新错误，可能需要重Roll:${t}`,{timeOut:6e3})}return y||a}let V=0;async function k(t){if(!('undefined'!=typeof jest||'undefined'!=typeof process&&!1)){const e=Date.now();if(e-V<3e3)return console.info(`Rate limit applied: handleVariablesInMessage skipped for message ${t}`),void toastr.warning('避免同时调用 MESSAGE_RECEIVED 多次','gemini轮询兼容',{timeOut:1e3});V=e}const e=getChatMessages(t).at(-1);if(!e)return;let a=e.message;if(a.length<5)return;const s=0===t?0:t-1,n=await T(s);if(!_.has(n,'stat_data'))return void console.error(`cannot found stat_data for ${s}`);if(await j(a,n)){const t=getVariables({type:'chat'});t.stat_data=n.stat_data,t.display_data=n.display_data,t.delta_data=n.delta_data,t.schema=n.schema,t.initialized_lorebooks=n.initialized_lorebooks,await replaceVariables(t,{type:'chat'})}await insertOrAssignVariables({stat_data:n.stat_data,display_data:n.display_data,delta_data:n.delta_data,schema:n.schema,initialized_lorebooks:n.initialized_lorebooks},{type:'message',message_id:t}),'user'!==e.role&&(a.includes('<StatusPlaceHolderImpl/>')||(a+='\n\n<StatusPlaceHolderImpl/>'),await setChatMessages([{message_id:t,message:a}],{refresh:'affected'}))}async function L(t,e){if(void 0===e.old_variables)return;e.new_variables=_.cloneDeep(e.old_variables);const a=e.new_variables;await j(t,a)||delete e.new_variables}function x(t,e,a,s){_.forEach(e,(t,e)=>{const n=e;if(_.isArray(t)){if(2===t.length&&_.isString(t[1])){if(_.isArray(_.get(a,n))){const i=_.get(a,n);if(2===i.length)if(_.set(s,`${n}[1]`,t[1]),_.isObject(t[0])&&!_.isArray(t[0])){const a=_.get(s,`${e}[0]`);_.has(t[0],'description')&&_.isString(t[0].description)&&_.has(i[0],'description')&&_.set(s,`${n}[0].description`,t[0].description),x(`${n}[0]`,t[0],i[0],a)}else _.isArray(t[0])&&x(`${n}[0]`,t[0],i[0],s[0])}}else if(_.isArray(_.get(a,n))){const e=_.get(a,n);t.forEach((a,i)=>{if(i<e.length&&_.isObject(a)){const r=_.get(s,`${n}[${i}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(e[i],'description')&&_.set(r,'description',a.description),x(`${n}[${i}]`,t[i],e[i],r)}})}}else if(_.isObject(t)){if(_.has(t,'description')&&_.isString(t.description)){const n=`${e}.description`;_.has(a,n)&&_.set(s,n,t.description)}_.has(a,e)&&_.isObject(a[e])&&x(n,t,a[e],s[e])}})}async function R(){let t,e;try{const a=await async function(){let t=[];try{t=await getChatMessages(-2,{role:'assistant',include_swipes:!0})}catch(t){}if(!t||t.length<=0){const e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))throw new Error('不存在任何一条消息');t=e}const e=t[0],a=e.swipes_data[e.swipe_id];return{message:e,variables:a}}();t=a.message,e=await T(a.message.message_id)??{display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}}}catch(t){return void console.error('不存在任何一条消息，退出')}if(void 0===e&&(e={display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}}),_.has(e,'initialized_lorebooks')||(e.initialized_lorebooks={}),Array.isArray(e.initialized_lorebooks)){console.warn('Old "initialized_lorebooks" array format detected. Migrating to the new object format.');const t=e.initialized_lorebooks,a={};for(const e of t)a[e]=[];e.initialized_lorebooks=a}e.stat_data||(e.stat_data={}),e.schema||(e.schema={extensible:!1,properties:{},type:'object'});const a=await C(e);if(a){}if(a||!e.schema||_.isEmpty(e.schema)){const t=p(_.cloneDeep(e.stat_data));o(t)?(_.has(e.stat_data,'$meta.strictTemplate')&&(t.strictTemplate=e.stat_data.$meta?.strictTemplate),_.has(e.stat_data,'$meta.concatTemplateArray')&&(t.concatTemplateArray=e.stat_data.$meta?.concatTemplateArray),_.has(e.stat_data,'$meta.strictSet')&&(t.strictSet=e.stat_data.$meta?.strictSet),e.schema=t):console.error('Generated schema is not an object schema, which is unexpected for stat_data root'),y(e.stat_data)}if(a){console.info('Init chat variables.'),await insertOrAssignVariables(e);for(let a=0;a<t.swipes.length;a++){const s=_.cloneDeep(e);await j(t.swipes[a],s),await setChatMessage({data:s},t.message_id,{refresh:'none',swipe_id:a})}try{toastr.info(`有新的世界书初始化变量被加载，当前使用世界书: ${YAML.stringify(e.initialized_lorebooks)}`,'变量初始化成功')}catch(t){}await async function(){const t={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},e=getLorebookSettings();_.isEqual(_.merge({},e,t),e)||setLorebookSettings(t)}()}}async function C(t,s){const n=s||await async function(){const t=[...(await getLorebookSettings()).selected_global_lorebooks],e=await getCurrentCharPrimaryLorebook();return null!==e&&t.push(e),t}();let i=!1;t.initialized_lorebooks&&!Array.isArray(t.initialized_lorebooks)||(t.initialized_lorebooks={});for(const s of n){if(_.has(t.initialized_lorebooks,s))continue;t.initialized_lorebooks[s]=[];const n=await getLorebookEntries(s);for(const s of n)if(s.comment?.toLowerCase().includes('[initvar]')){const n=substitudeMacros(s.content);let i=null,r=null;try{i=YAML.parse(n)}catch(t){try{i=e.parse(n)}catch(t){try{i=a.parse(n)}catch(t){r=new Error(`Failed to parse content as YAML/JSON, JSON5, or TOML: ${t}`)}}}if(r)throw console.error(`Failed to parse lorebook entry[${s.comment}]: ${r}`),toastr.error(r.message,'Failed to parse lorebook entry',{timeOut:5e3}),r;i&&(t.stat_data=_.merge(t.stat_data,i))}i=!0}return i}const P=['重新处理变量','重新读取初始变量','清除旧楼层变量'];let G=0;function J(){!function(){const t=getScriptButtons(getScriptId()),e=t.map(t=>t.name);for(const a of P.filter(t=>!e.includes(t)))t.push({name:a,visible:!1});replaceScriptButtons(getScriptId(),t)}(),eventOnButton('重新处理变量',async function(){if(!('undefined'!=typeof jest||'undefined'!=typeof process&&!1)){const t=Date.now();if(t-G<3e3)return console.info('Rate limit applied: 重新处理变量 button skipped'),void toastr.warning('避免重复点击','防止连点',{timeOut:1e3});G=t}const t=getLastMessageId();t<1||0!==SillyTavern.chat.length&&(await deleteVariable('stat_data',{type:'message',message_id:t}),await deleteVariable('delta_data',{type:'message',message_id:t}),await deleteVariable('display_data',{type:'message',message_id:t}),await deleteVariable('schema',{type:'message',message_id:t}),await k(getLastMessageId()))}),eventOnButton('重新读取初始变量',async function(){const t={display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}};try{if(!await C(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','',{timeOut:3e3})}catch(t){return void console.error('加载 InitVar 数据失败:',t)}const e=getLastMessageId();if(e<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','',{timeOut:3e3});const a=await T(e);if(!_.has(a,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','',{timeOut:3e3});const s=structuredClone(t);s.stat_data=_.merge(s.stat_data,a.stat_data),x(0,t.stat_data,a.stat_data,s.stat_data),await g(s),y(s.stat_data),await replaceVariables(s,{type:'message',message_id:e}),await replaceVariables(s,{type:'chat'}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','',{timeOut:3e3})}),eventOnButton('清除旧楼层变量',async function(){const t=await SillyTavern.callGenericPopup('<h4>清除旧楼层变量信息以减小聊天文件大小避免手机崩溃</h4>请填写要保留变量信息的楼层数 (如 10 为保留最后 10 层)<br><strong>注意: 你将不能正常回退游玩到没保留变量信息的楼层</strong>',SillyTavern.POPUP_TYPE.INPUT,'10');if(!t)return;const e=parseInt(t);isNaN(e)?toastr.error(`请输入有效的楼层数, 你输入的是 '${t}'`,'清理旧楼层变量失败'):(SillyTavern.chat.slice(0,-e).forEach(t=>{void 0!==t.variables&&t.variables.forEach(t=>{_.unset(t,'stat_data'),_.unset(t,'display_data'),_.unset(t,'delta_data'),_.unset(t,'schema')})}),SillyTavern.saveChat().then(()=>toastr.success(`已清理旧变量, 保留了最后 ${e} 层的变量`,'清理旧楼层变量成功')))})}function B(){return{events:c,parseMessage:async function(t,e){const a={old_variables:e};return await L(t,a),a.new_variables},getMvuData:function(t){return getVariables(t)},replaceMvuData:async function(t,e){await replaceVariables(t,e)},getCurrentMvuData:function(){return getVariables({type:'message',message_id:getCurrentMessageId()})},replaceCurrentMvuData:async function(t){await replaceVariables(t,{type:'message',message_id:getCurrentMessageId()})},reloadInitVar:async function(t){return await C(t)},setMvuVariable:async function(t,e,a,{reason:s='',is_recursive:n=!1}={}){return await M(t.stat_data,e,a,s,n)},getMvuVariable:function(t,e,{category:a='stat',default_value:s}={}){let n;switch(a){case'stat':n=t.stat_data;break;case'display':n=t.display_data;break;case'delta':n=t.delta_data}const i=_.get(n,e,s);return function(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]}(i)?i[0]:i},getRecordFromMvuData:function(t,e){return function(t,e){let a;switch(t){case'stat':a=e.stat_data;break;case'display':a=e.display_data;break;case'delta':a=e.delta_data}return a}(e,t)}}}$(async()=>{J(),function(){const t=B();_.set(window,'Mvu',t),_.set(window.parent,'Mvu',t)}(),eventOn(tavern_events.GENERATION_STARTED,R),eventOn(tavern_events.MESSAGE_SENT,R),eventOn(tavern_events.MESSAGE_SENT,k),eventOn(tavern_events.MESSAGE_RECEIVED,k),eventOn(l,L),eventOn(d,M),await E();try{_.set(parent.window,'handleVariablesInMessage',k)}catch(t){}try{toastr.info('构建信息: 2025-08-29T14:46:56.564Z (3113279)','MVU加载成功');const t=await getTavernHelperVersion();s(t,'3.2.13','<')&&toastr.warning('酒馆助手版本过低, 可能无法正常处理, 请更新至 3.2.13 或更高版本（建议保持酒馆助手最新）')}catch(t){}}),$(window).on('unload',()=>{eventRemoveListener(tavern_events.GENERATION_STARTED,R),eventRemoveListener(tavern_events.MESSAGE_SENT,R),eventRemoveListener(tavern_events.MESSAGE_SENT,k),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,k),eventRemoveListener(l,L)});
//# sourceMappingURL=bundle.js.map
